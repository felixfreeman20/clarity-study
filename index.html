<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clarity | Pro Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #4f46e5; --glass: rgba(255, 255, 255, 0.7); }
        body { font-family: 'Inter', sans-serif; background: #fff; color: #1a1a1a; margin: 0; overflow-x: hidden; }
        
        /* Centered Premium Container */
        .workspace-container { 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 120px 20px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* Sidebar - Workspace Style */
        .sidebar { width: 260px; height: 100vh; position: fixed; left: 0; top: 0; border-right: 1px solid #f0f0f0; background: var(--glass); backdrop-filter: blur(20px); padding: 40px 24px; z-index: 40; }
        
        /* Logo Refined */
        .logo-container { position: absolute; top: 35px; left: 50%; transform: translateX(-50%); z-index: 50; pointer-events: none; }
        .app-logo { height: 95px; width: auto; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.05)); }

        /* Mode Grid - Centered & Refined */
        .mode-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; width: 100%; margin-bottom: 32px; }
        .mode-card { 
            background: #fff; border: 1px solid #f0f0f0; padding: 20px; border-radius: 20px; text-align: center; cursor: pointer; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .mode-card:hover { border-color: #000; transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.03); }
        .mode-card.active { background: #000; color: #fff; border-color: #000; }

        /* Input Area */
        .glass-input { 
            width: 100%; height: 350px; border-radius: 28px; border: 1px solid #f0f0f0; background: #fcfcfc; 
            font-size: 1.15rem; outline: none; padding: 35px; line-height: 1.7; transition: 0.4s; resize: none;
        }
        .glass-input:focus { background: #fff; border-color: #000; box-shadow: 0 20px 50px rgba(0,0,0,0.04); }

        .btn-primary { background: #000; color: #fff; padding: 18px 50px; border-radius: 18px; font-weight: 600; font-size: 1.05rem; transition: 0.3s; cursor: pointer; border: none; width: 100%; max-width: 300px; }
        .btn-primary:hover { transform: scale(1.02); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }

        /* Sidebar UI */
        .heat-map { display: flex; gap: 4px; margin-top: 10px; }
        .heat-cell { width: 10px; height: 10px; border-radius: 2px; background: #f3f4f6; }
        .heat-cell.active { background: #000; }
        
        .sound-chip { padding: 6px 14px; border: 1px solid #eee; border-radius: 20px; font-size: 11px; font-weight: 700; transition: 0.2s; cursor: pointer; text-transform: uppercase; }
        .sound-chip.active { background: #000; color: #fff; border-color: #000; }

        /* Result Area */
        #outputArea { margin-top: 60px; width: 100%; padding: 40px; border-radius: 30px; border: 1px solid #eee; background: #fff; }
        .status-badge { font-size: 10px; font-weight: 800; text-transform: uppercase; color: #999; letter-spacing: 1px; }

        /* Loader */
        .dots { display: flex; gap: 5px; justify-content: center; padding: 20px; }
        .dot { width: 8px; height: 8px; background: #000; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="logo-container">
        <img src="Clarity Logo.png" alt="Clarity" class="app-logo">
    </div>

    <aside class="sidebar flex flex-col">
        <div class="h-28"></div>
        <nav class="space-y-6 flex-1">
            <a href="index.html" class="flex items-center gap-3 font-bold text-black text-lg italic">‚ú¶ Workspace</a>
            <a href="saved.html" id="nav-saved" class="flex items-center gap-3 text-gray-400 hover:text-black transition text-lg">üìÅ Archive</a>
            
            <div class="pt-8">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Your Progress</p>
                <div class="heat-map">
                    <div class="heat-cell active"></div><div class="heat-cell"></div><div class="heat-cell active"></div><div class="heat-cell"></div><div class="heat-cell active"></div><div class="heat-cell active"></div><div class="heat-cell"></div>
                </div>
            </div>

            <div class="pt-8">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Focus Sounds</p>
                <div class="flex gap-2 flex-wrap">
                    <div id="lofi-chip" onclick="toggleAudio('lofi')" class="sound-chip">Lo-Fi</div>
                    <div id="rain-chip" onclick="toggleAudio('rain')" class="sound-chip">Rain</div>
                </div>
            </div>
        </nav>
        <div class="pt-8 border-t border-gray-100">
            <p id="user-display" class="font-bold text-lg text-black">Alon</p>
            <button id="logoutBtn" class="text-xs text-red-500 hover:underline">Sign Out</button>
        </div>
    </aside>

    <main class="workspace-container">
        <h2 class="text-6xl font-medium tracking-tighter mb-10 text-center">Make it <span class="text-gray-200">clear.</span></h2>

        <div class="mode-grid">
            <div class="mode-card active" data-mode="summary">
                <span class="text-2xl">üìñ</span>
                <p class="font-bold text-[10px] mt-2 uppercase tracking-widest">Deep Dive</p>
            </div>
            <div class="mode-card" data-mode="speed">
                <span class="text-2xl">‚ö°</span>
                <p class="font-bold text-[10px] mt-2 uppercase tracking-widest">Speed Review</p>
            </div>
            <div class="mode-card" data-mode="quiz">
                <span class="text-2xl">üß†</span>
                <p class="font-bold text-[10px] mt-2 uppercase tracking-widest">Mastery Quiz</p>
            </div>
            <div class="mode-card" data-mode="glossary">
                <span class="text-2xl">üè∑Ô∏è</span>
                <p class="font-bold text-[10px] mt-2 uppercase tracking-widest">Glossary</p>
            </div>
        </div>

        <textarea id="studyInput" class="glass-input mb-10" placeholder="Paste notes, articles, or transcripts here..."></textarea>
        
        <button id="generateBtn" class="btn-primary">Generate Session</button>

        <div id="outputArea" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <span class="status-badge">AI Response</span>
                <button id="saveBtn" class="text-sm font-bold text-blue-600 hover:underline">Save to Archive</button>
            </div>
            <div id="aiResult" class="prose max-w-none text-black leading-relaxed"></div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = { 
            apiKey: "AIzaSyAoyilOSkLk7uQVC4znit855wfAwVXU3Uo", 
            authDomain: "clarity-study-cd835.firebaseapp.com", 
            projectId: "clarity-study-cd835", 
            storageBucket: "clarity-study-cd835.firebasestorage.app", 
            messagingSenderId: "92484724607", appId: "1:92484724607:web:d07cbc3f0238264ecf9c4a" 
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentMode = 'summary';
        let currentUser = null;
        let lastResult = "";

        // 1. Auth Handling
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-display').innerText = user.displayName || "Alon";
            } else {
                window.location.href = "index.html";
            }
        });

        document.getElementById('logoutBtn').onclick = () => signOut(auth).then(() => window.location.reload());

        // 2. Mode Selection
        document.querySelectorAll('.mode-card').forEach(card => {
            card.onclick = () => {
                document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                currentMode = card.dataset.mode;
            };
        });

        // 3. Focus Sounds Logic
        let audioPlayer = new Audio();
        window.toggleAudio = (type) => {
            const chip = document.getElementById(`${type}-chip`);
            const sounds = {
                lofi: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
                rain: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3'
            };

            if (audioPlayer.src === sounds[type] && !audioPlayer.paused) {
                audioPlayer.pause();
                chip.classList.remove('active');
            } else {
                document.querySelectorAll('.sound-chip').forEach(c => c.classList.remove('active'));
                audioPlayer.src = sounds[type];
                audioPlayer.play();
                chip.classList.add('active');
            }
        };

        // 4. Generation Logic
        document.getElementById('generateBtn').onclick = async () => {
            const input = document.getElementById('studyInput').value;
            if (!input) return alert("Please paste some content first!");

            const btn = document.getElementById('generateBtn');
            const resultDiv = document.getElementById('aiResult');
            const outputArea = document.getElementById('outputArea');

            btn.disabled = true;
            btn.innerText = "Processing...";
            outputArea.classList.remove('hidden');
            resultDiv.innerHTML = `<div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;

            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer gsk_mS130fO8mG4137tBEnGOWGdyb3FY0jX739yRk09B2v9Y637y', // Replace with secure env variable if possible
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "llama3-8b-8192",
                        messages: [{ role: "user", content: `Perform a ${currentMode} on this text: ${input}` }]
                    })
                });

                const data = await response.json();
                lastResult = data.choices[0].message.content;
                resultDiv.innerText = lastResult;
                btn.disabled = false;
                btn.innerText = "Generate Session";
            } catch (error) {
                resultDiv.innerText = "Generation failed. Please check your API limits.";
                btn.disabled = false;
                btn.innerText = "Try Again";
            }
        };

        // 5. Save Logic
        document.getElementById('saveBtn').onclick = async () => {
            if (!lastResult || !currentUser) return;
            try {
                await addDoc(collection(db, "sessions"), {
                    uid: currentUser.uid,
                    content: lastResult,
                    mode: currentMode,
                    timestamp: serverTimestamp()
                });
                alert("Saved to Archive!");
            } catch (e) {
                alert("Error saving session.");
            }
        };
    </script>
</body>
</html>
