<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clarity | Studio Environment</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* ==========================================================================
           1. DESIGN SYSTEM & COLOR TOKENS
           ========================================================================== */
        :root {
            /* Core Palette */
            --c-canvas: #ffffff;
            --c-ink: #000000;
            --c-border: #000000;
            
            /* Accent Injections */
            --c-accent-blue: #3b82f6;    /* Logic Blue */
            --c-accent-purple: #8b5cf6;  /* Pro Purple */
            --c-accent-red: #ef4444;     /* Alert Red */
            --c-accent-green: #10b981;   /* Success Green */
            
            /* Surface Tones */
            --c-surface-light: #f4f4f5;
            --c-surface-muted: #fafafa;
            --c-surface-dark: #18181b;
            
            /* Structural Constraints */
            --sidebar-w: 280px;
            --radius-pill: 100px;
            --radius-card: 40px;
            
            /* Motion Dynamics */
            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
            --transition-main: all 0.4s var(--ease-out-expo);
        }

        /* ==========================================================================
           2. GLOBAL RESET & FOUNDATION
           ========================================================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            background-color: var(--c-canvas);
            color: var(--c-ink);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            line-height: 1.5;
        }

        button {
            cursor: pointer;
            border: none;
            background: none;
            font-family: inherit;
            transition: var(--transition-main);
        }

        textarea {
            font-family: inherit;
        }

        /* CUSTOM SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #000; border-radius: 4px; border: 2px solid #fff; }

        /* ==========================================================================
           3. SIDEBAR NAVIGATION SYSTEM
           ========================================================================== */
        .app-sidebar {
            position: fixed;
            left: 0; top: 0; bottom: 0;
            width: var(--sidebar-w);
            border-right: 1px solid #f0f0f0;
            padding: 60px 45px;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            z-index: 1000;
        }

        .brand-container {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 70px;
        }

        .brand-glyph {
            width: 24px;
            height: 24px;
            background: var(--c-accent-blue);
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            transition: var(--transition-main);
        }

        .brand-container:hover .brand-glyph {
            transform: rotate(90deg) scale(1.1);
        }

        .brand-text {
            font-weight: 900;
            font-size: 24px;
            letter-spacing: -0.06em;
            text-transform: uppercase;
        }

        .nav-stack {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-grow: 1;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 0;
            color: #71717a;
            font-weight: 800;
            font-size: 14px;
            letter-spacing: 0.02em;
            transition: var(--transition-main);
        }

        .nav-link:hover {
            color: var(--c-accent-blue);
            transform: translateX(4px);
        }

        .nav-link.active {
            color: #000000;
            border-right: 4px solid #000;
        }

        .nav-link svg {
            width: 20px;
            height: 20px;
            stroke-width: 2.5px;
        }

        .sidebar-user-block {
            margin-top: auto;
            padding-top: 40px;
            border-top: 1px solid #f4f4f5;
        }

        .profile-bead {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .avatar-surface {
            width: 44px;
            height: 44px;
            background: #000;
            color: #fff;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 18px;
        }

        .user-meta-name {
            font-weight: 900;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: -0.01em;
            color: #000;
        }

        .logout-trigger {
            font-size: 10px;
            font-weight: 900;
            color: #a1a1aa;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            margin-top: 2px;
        }

        .logout-trigger:hover { color: var(--c-accent-red); }

        /* ==========================================================================
           4. MAIN CONTENT ARCHITECTURE
           ========================================================================== */
        .workspace-main {
            margin-left: var(--sidebar-w);
            padding: 90px 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .view-frame {
            width: 100%;
            max-width: 1000px;
            display: none;
            animation: viewFadeUp 0.7s var(--ease-out-expo);
        }

        .view-frame.active-view {
            display: block;
        }

        @keyframes viewFadeUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==========================================================================
           5. THE STUDIO COMPONENT (BRUTALIST REFINED)
           ========================================================================== */
        .studio-enclosure {
            border: 2px solid var(--c-border);
            border-radius: var(--radius-card);
            background: #ffffff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 15px 45px rgba(0,0,0,0.03);
            transition: var(--transition-main);
        }

        .studio-enclosure:focus-within {
            box-shadow: 0 50px 100px rgba(0,0,0,0.1);
            transform: translateY(-5px);
            border-color: var(--c-accent-blue);
        }

        /* Context Upload Header */
        .context-sync-bar {
            padding: 24px;
            background: var(--c-surface-muted);
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: #52525b;
            transition: var(--transition-main);
        }

        .context-sync-bar:hover {
            background: var(--c-accent-blue);
            color: #ffffff;
        }

        /* Mode & Config Toolbar */
        .studio-toolbar {
            padding: 24px 45px;
            border-bottom: 1px solid #f4f4f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffffff;
        }

        .mode-selection-group {
            display: flex;
            background: var(--c-surface-light);
            padding: 6px;
            border-radius: 20px;
            gap: 5px;
        }

        .mode-trigger {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 26px;
            border-radius: 16px;
            font-weight: 800;
            font-size: 12px;
            text-transform: uppercase;
            color: #71717a;
        }

        .mode-trigger svg {
            width: 16px;
            height: 16px;
            stroke-width: 3px;
        }

        .mode-trigger.active {
            background-color: #000000;
            color: #ffffff;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        /* QUIZ SLIDER SYSTEM (CRITICAL) */
        .quiz-engine-controls {
            display: none; /* Injected via JS */
            align-items: center;
            gap: 25px;
            padding-left: 30px;
            border-left: 2px solid #f0f0f0;
        }

        .q-count-bead {
            font-size: 14px;
            font-weight: 900;
            color: var(--c-accent-blue);
            width: 30px;
        }

        .logic-slider-wrap {
            position: relative;
            width: 180px;
            height: 8px;
            background: #e4e4e7;
            border-radius: 10px;
        }

        .logic-slider-input {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            position: absolute;
            top: -6px;
            z-index: 20;
        }

        .logic-slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #000;
            border: 4px solid #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            cursor: pointer;
            transition: 0.2s;
        }

        .logic-slider-input::-webkit-slider-thumb:hover { transform: scale(1.15); }

        .pro-threshold-line {
            position: absolute;
            left: 20%;
            top: -10px;
            width: 3px;
            height: 28px;
            background: var(--c-accent-red);
            border-radius: 2px;
            z-index: 10;
        }

        .pro-threshold-tag {
            position: absolute;
            left: 20%;
            top: -28px;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: 900;
            color: var(--c-accent-red);
            letter-spacing: 0.05em;
        }

        /* Primary Editor Input */
        #main-studio-input {
            width: 100%;
            min-height: 520px;
            padding: 70px 90px;
            font-size: 26px;
            line-height: 1.6;
            font-weight: 500;
            color: #000000;
            border: none;
            outline: none;
            resize: none;
            text-align: left;
        }

        #main-studio-input::placeholder { color: #d1d5db; }

        /* ==========================================================================
           6. ACTIONS & SYNTHESIS RENDERING
           ========================================================================== */
        .action-container {
            margin-top: -42px;
            position: relative;
            z-index: 50;
        }

        .btn-generate-synthesis {
            background: #000000;
            color: #ffffff;
            padding: 28px 80px;
            border-radius: var(--radius-pill);
            font-weight: 900;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 0.25em;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 6px solid #ffffff;
            box-shadow: 0 25px 50px rgba(0,0,0,0.18);
        }

        .btn-generate-synthesis:hover {
            transform: scale(1.05);
            background: var(--c-accent-blue);
            box-shadow: 0 35px 70px rgba(59, 130, 246, 0.3);
        }

        .synthesis-output-area {
            width: 100%;
            max-width: 840px;
            margin-top: 110px;
            display: none;
        }

        .synthesis-marker {
            height: 3px;
            background: #000000;
            width: 100px;
            margin-bottom: 50px;
        }

        .synthesis-content h2 {
            font-weight: 900;
            font-size: 52px;
            letter-spacing: -0.05em;
            line-height: 1;
            margin-bottom: 35px;
            text-transform: uppercase;
        }

        .synthesis-content p {
            font-size: 22px;
            line-height: 1.8;
            color: #18181b;
            margin-bottom: 28px;
            font-weight: 500;
        }

        .synthesis-content b {
            color: var(--c-accent-blue);
            font-weight: 900;
        }

        /* ==========================================================================
           7. PRO PAGE & FEATURE GRID
           ========================================================================== */
        .pro-hero-section {
            text-align: center;
            padding: 40px 0 80px;
        }

        .feature-matrix {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 60px;
        }

        .matrix-card {
            padding: 45px;
            border: 3px solid #000;
            border-radius: 35px;
            transition: var(--transition-main);
        }

        .matrix-card:hover {
            transform: translateY(-10px);
            background: var(--c-surface-light);
        }

        .matrix-card h4 {
            font-weight: 900;
            font-size: 20px;
            text-transform: uppercase;
            margin-bottom: 15px;
        }

        /* ==========================================================================
           8. SYSTEM OVERLAYS & MODALS
           ========================================================================== */
        .system-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.98);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .modal-identity-box {
            background: #ffffff;
            width: 100%;
            max-width: 480px;
            border: 5px solid #000;
            border-radius: 50px;
            padding: 70px 55px;
            text-align: center;
            position: relative;
            box-shadow: 0 60px 120px rgba(0,0,0,0.15);
        }

    </style>
</head>
<body>

    <div id="pro-modal-overlay" class="system-modal-overlay">
        <div class="modal-identity-box">
            <button onclick="closeModal()" class="absolute top-10 left-10 text-4xl font-black hover:text-red-500 transition-colors">&times;</button>
            <div class="w-20 h-20 bg-black rounded-3xl mx-auto mb-10 flex items-center justify-center shadow-2xl">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3.5"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            </div>
            <h3 class="text-4xl font-black mb-6 uppercase tracking-tighter leading-tight">Elevate Your Engine</h3>
            <p class="text-gray-500 font-bold mb-12 px-2">Access Unlimited Quiz Generation, Timed Exam Simulations, and 3,000 Word Context Windows.</p>
            <div class="bg-gray-100 rounded-[35px] p-10 mb-10 border-2 border-dashed border-gray-300">
                <span class="text-6xl font-black text-black">$4.99</span> <span class="text-gray-400 font-extrabold text-sm uppercase">/ Month</span>
            </div>
            <button class="w-full bg-black text-white py-7 rounded-full font-black uppercase tracking-widest text-sm hover:bg-blue-600 hover:scale-105 transition-all">Enable Pro Logic</button>
        </div>
    </div>

    <aside class="app-sidebar">
        <div class="brand-container">
            <div class="brand-glyph"></div>
            <h1 class="brand-text">CLARITY</h1>
        </div>

        <nav class="nav-stack">
            <button onclick="navigateViews('studio')" id="nav-item-studio" class="nav-link active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 6h16M4 12h16M4 18h7"/></svg>
                STUDIO WORKSPACE
            </button>
            <button onclick="navigateViews('pro')" id="nav-item-pro" class="nav-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                PRO CAPABILITIES
            </button>
            <button onclick="navigateViews('settings')" id="nav-item-settings" class="nav-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>
                ENVIRONMENT SETTINGS
            </button>
        </nav>

        <div class="sidebar-user-block">
            <div class="profile-bead">
                <div id="user-initial" class="avatar-surface">?</div>
                <div>
                    <p id="user-display-name" class="user-meta-name">Loading...</p>
                    <button onclick="systemLogout()" class="logout-trigger">Sign Out Terminus</button>
                </div>
            </div>
        </div>
    </aside>

    <main class="workspace-main">

        <section id="view-studio" class="view-frame active-view">
            <div class="studio-enclosure">
                <div class="context-sync-bar" onclick="document.getElementById('input-pdf-sync').click()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3.5"><path d="M12 5v14M5 12h14"/></svg>
                    <span>Connect Contextual Knowledge (PDF)</span>
                    <input type="file" id="input-pdf-sync" class="hidden" accept=".pdf">
                </div>

                <div class="studio-toolbar">
                    <div class="flex items-center">
                        <div class="mode-selection-group">
                            <button class="mode-trigger active" onclick="setStudioMode('deep', this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 21a9 9 0 100-18 9 9 0 000 18zM12 8v4m0 4h.01"/></svg>
                                Deep
                            </button>
                            <button class="mode-trigger" onclick="setStudioMode('speed', this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                Speed
                            </button>
                            <button class="mode-trigger" onclick="setStudioMode('quiz', this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 11l3 3L22 4m-2 12a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                Quiz
                            </button>
                            <button class="mode-trigger" onclick="setStudioMode('exam', this)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                Exam
                            </button>
                        </div>

                        <div id="dynamic-quiz-controls" class="quiz-engine-controls">
                            <span id="label-quiz-val" class="q-count-bead">10</span>
                            <div class="logic-slider-wrap">
                                <div class="pro-threshold-line"></div>
                                <div class="pro-threshold-tag">PRO</div>
                                <input type="range" id="input-quiz-slider" class="logic-slider-input" min="5" max="50" step="5" value="10">
                            </div>
                        </div>
                    </div>
                    <div id="stat-word-count" class="text-[11px] font-black text-gray-300 uppercase tracking-[0.2em]">0 / 1000 WORDS</div>
                </div>

                <textarea id="main-studio-input" placeholder="Paste your raw lecture notes, data sets, or research drafts here for logical synthesis..."></textarea>
            </div>

            <div class="action-container">
                <button id="btn-trigger-engine" class="btn-generate-synthesis">
                    EXECUTE SYNTHESIS
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </button>
            </div>

            <div id="render-area-synthesis" class="synthesis-output-area">
                <div class="synthesis-marker"></div>
                <div id="synthesis-target-container" class="synthesis-content">
                    </div>
            </div>
        </section>

        <section id="view-pro" class="view-frame text-center">
            <div class="pro-hero-section">
                <h2 class="text-7xl font-black uppercase tracking-tighter mb-6">Master the Logic.</h2>
                <p class="text-2xl text-gray-500 font-semibold max-w-2xl mx-auto">Clarity Pro is designed for high-volume academic processing and precision testing.</p>
            </div>
            
            <div class="feature-matrix">
                <div class="matrix-card">
                    <div class="text-blue-600 mb-6"><svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></div>
                    <h4>3,000 Word Logic</h4>
                    <p class="text-gray-500 font-medium leading-relaxed">Synthesize entire research papers and legal briefings in a single logical pass.</p>
                </div>
                <div class="matrix-card">
                    <div class="text-purple-600 mb-6"><svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                    <h4>Exam Simulation</h4>
                    <p class="text-gray-500 font-medium leading-relaxed">Turn your notes into timed, adaptive exams that grade your conceptual accuracy.</p>
                </div>
                <div class="matrix-card">
                    <div class="text-red-500 mb-6"><svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg></div>
                    <h4>50 Question Logic</h4>
                    <p class="text-gray-500 font-medium leading-relaxed">Maximum volume practice sets to ensure comprehensive material coverage.</p>
                </div>
            </div>

            <button class="bg-black text-white px-20 py-8 rounded-full font-black text-xl hover:bg-blue-600 transition-all shadow-xl">ACTIVATE FOR $4.99/MO</button>
        </section>

        <section id="view-settings" class="view-frame">
            <h2 class="text-5xl font-black uppercase tracking-tighter mb-16">System Environment</h2>
            
            <div class="bg-white border-4 border-black p-12 rounded-[40px] flex justify-between items-center shadow-2xl">
                <div>
                    <h3 class="text-2xl font-black mb-2 uppercase">Cache Terminus</h3>
                    <p class="text-gray-500 font-bold max-w-md">This will permanently delete your local identity cache and session nickname from the secure database.</p>
                </div>
                <button onclick="triggerDataFlush()" class="bg-white border-4 border-red-500 text-red-500 px-10 py-5 rounded-3xl font-black uppercase text-sm tracking-widest hover:bg-red-50 transition-all">Flush Identity</button>
            </div>
        </section>

    </main>

    <script type="module">
        // --- 1. CORE DEPENDENCIES ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 2. ENGINE INITIALIZATION ---
        const CLARITY_CONFIG = { 
            apiKey: "AIzaSyAoyilOSkLk7uQVC4znit855wfAwVXU3Uo", 
            authDomain: "clarity-study-cd835.firebaseapp.com", 
            projectId: "clarity-study-cd835", 
            storageBucket: "clarity-study-cd835.firebasestorage.app", 
            messagingSenderId: "92484724607", 
            appId: "1:92484724607:web:d07cbc3f0238264ecf9c4a" 
        };
        const app = initializeApp(CLARITY_CONFIG);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 3. STATE REPOSITORY ---
        let SESSION_USER = null;
        let CURRENT_ENGINE_MODE = 'deep';
        
        // DOM REFERENCES
        const UI = {
            mainInput: document.getElementById('main-studio-input'),
            wordCounter: document.getElementById('stat-word-count'),
            quizControls: document.getElementById('dynamic-quiz-controls'),
            quizSlider: document.getElementById('input-quiz-slider'),
            quizValueLabel: document.getElementById('label-quiz-val'),
            resultsArea: document.getElementById('render-area-synthesis'),
            resultsTarget: document.getElementById('synthesis-target-container'),
            modal: document.getElementById('pro-modal-overlay'),
            userInitials: document.getElementById('user-initial'),
            userFullName: document.getElementById('user-display-name')
        };

        // --- 4. AUTHENTICATION & IDENTITY BRIDGE ---
        onAuthStateChanged(auth, async (u) => {
            if(!u) return window.location.href="index.html";
            
            try {
                const userDoc = await getDoc(doc(db, "users", u.uid));
                if(userDoc.exists()) {
                    SESSION_USER = userDoc.data();
                    const name = (SESSION_USER.nickname || "STUDENT").toUpperCase();
                    UI.userFullName.innerText = name;
                    UI.userInitials.innerText = name.charAt(0);
                }
            } catch (error) {
                console.error("Clarity Engine Identity Failure:", error);
            }
        });

        // --- 5. STUDIO INPUT MONITOR ---
        UI.mainInput.addEventListener('input', () => {
            const raw = UI.mainInput.value.trim();
            const wordCount = raw === '' ? 0 : raw.split(/\s+/).length;
            const limit = SESSION_USER?.isPro ? 3000 : 1000;
            
            UI.wordCounter.innerText = `${wordCount} / ${limit} WORDS`;
            
            if(wordCount > limit) {
                UI.wordCounter.style.color = "#ef4444";
                const overflowFix = UI.mainInput.value.split(/\s+/).slice(0, limit).join(" ");
                UI.mainInput.value = overflowFix;
            } else {
                UI.wordCounter.style.color = "#d1d5db";
            }
        });

        // --- 6. NAVIGATION & VIEWPORT CONTROLLER ---
        window.navigateViews = (viewId) => {
            document.querySelectorAll('.view-frame').forEach(v => v.classList.remove('active-view'));
            document.getElementById(`view-${viewId}`).classList.add('active-view');
            
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById(`nav-item-${viewId}`).classList.add('active');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // --- 7. STUDIO MODE & SLIDER LOGIC ---
        window.setStudioMode = (mode, triggerElement) => {
            if(mode === 'exam' && !SESSION_USER?.isPro) {
                window.openModal();
                return;
            }

            CURRENT_ENGINE_MODE = mode;
            document.querySelectorAll('.mode-trigger').forEach(m => m.classList.remove('active'));
            triggerElement.classList.add('active');
            
            // Toggle Quiz Logic UI
            UI.quizControls.style.display = (mode === 'quiz') ? 'flex' : 'none';
        };

        // QUIZ SLIDER CONSTRAINTS
        UI.quizSlider.addEventListener('input', (e) => {
            let val = parseInt(e.target.value);
            
            // Enforcement of Pro Limit on Slider
            if(!SESSION_USER?.isPro && val > 10) {
                UI.quizSlider.value = 10;
                val = 10;
                window.openModal();
            }
            UI.quizValueLabel.innerText = val;
        });

        // --- 8. SYNTHESIS EXECUTION ENGINE ---
        document.getElementById('btn-trigger-engine').onclick = () => {
            const content = UI.mainInput.value.toLowerCase().trim();
            if(!content) return;

            UI.resultsArea.style.display = 'block';
            let synthesisHtml = "";

            // SPECIFIC LOGIC: CIVIL WAR ANALYSIS TRIGGER
            if(content.includes("civil war") || content.includes("american civil")) {
                synthesisHtml = `
                    <h2>Civil War: Strategic Attrition</h2>
                    <p>Your notes emphasize battlefield dates, but the <b>Clarity Logic Engine</b> has identified the underlying <i>Logistics Gap</i> as the primary causal factor.</p>
                    <p><b>Logic Thread:</b> You mentioned the 'Anaconda Plan'. Note the mathematical impossibility for the South: A <b>3:1 Railroad Density</b> deficit made tactical interior lines irrelevant by 1863.</p>
                    <p><b>Critical Exam Path:</b> Study the intersection of the <i>Emancipation Proclamation</i> not just as a moral act, but as a <b>diplomatic weapon</b> that neutralized British textile-driven intervention.</p>
                `;
            } 
            // LOGIC BRANCH: QUIZ MODE
            else if(CURRENT_ENGINE_MODE === 'quiz') {
                const count = UI.quizSlider.value;
                synthesisHtml = `
                    <h2>Quiz Simulation Active</h2>
                    <p>The Clarity Engine is distilling <b>${count} critical questions</b> from your material.</p>
                    <p><b>Focus Pattern:</b> The AI has detected a high concentration of causal "if/then" statements in your second paragraph. Most questions will focus on these relationships.</p>
                    <div style="background:#f4f4f5; padding:25px; border-radius:20px; font-weight:700;">
                        Generating ${count} questions... [Complete]
                    </div>
                `;
            }
            // DEFAULT SYNTHESIS
            else {
                synthesisHtml = `
                    <h2>Synthesis Complete</h2>
                    <p>Your material regarding <b>${UI.mainInput.value.split(' ')[0]}</b> has been processed.</p>
                    <p><b>Logical Structure:</b> The input follows a linear chronological flow. To improve memory retention by 40%, the engine suggests re-mapping this data into a <i>Causal Hierarchy</i>.</p>
                `;
            }

            UI.resultsTarget.innerHTML = synthesisHtml;
            
            // Smooth scroll to results
            setTimeout(() => {
                window.scrollTo({ top: UI.resultsArea.offsetTop - 50, behavior: 'smooth' });
            }, 150);
        };

        // --- 9. UTILITIES & TERMINUS FUNCTIONS ---
        window.openModal = () => UI.modal.style.display = 'flex';
        window.closeModal = () => UI.modal.style.display = 'none';
        
        window.systemLogout = () => {
            if(confirm("Terminate Clarity Session?")) signOut(auth);
        };

        window.triggerDataFlush = async () => {
            if(confirm("FLUSH DATA: This will permanently wipe your session nickname. Proceed?")) {
                await updateDoc(doc(db, "users", auth.currentUser.uid), { nickname: "" });
                location.reload();
            }
        };

        // PDF DROPZONE HANDLER
        const dropzone = document.querySelector('.context-sync-bar');
        dropzone.ondragover = (e) => { 
            e.preventDefault(); 
            dropzone.style.background = "var(--c-accent-blue)"; 
            dropzone.style.color = "#fff"; 
        };
        dropzone.ondragleave = () => { 
            dropzone.style.background = "var(--c-surface-muted)"; 
            dropzone.style.color = "#52525b"; 
        };
        dropzone.ondrop = (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            dropzone.innerHTML = `<span>SYNCED: ${file.name.toUpperCase()}</span>`;
            dropzone.style.background = "var(--c-accent-green)";
            dropzone.style.color = "#fff";
        };

    </script>
</body>
</html>
